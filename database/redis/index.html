<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>redis | 一朝春诔</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="assets/img/favicon.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <meta name="description" content="一朝春诔的学习笔记">
    <meta name="author" content="一朝春诔">
    <meta name="keywords" content="vuepress介绍，vuepress说明，一朝春诔">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.27faccf6.css" as="style"><link rel="preload" href="/assets/js/app.dc260280.js" as="script"><link rel="preload" href="/assets/js/6.a4c4b5d6.js" as="script"><link rel="preload" href="/assets/js/2.1492d491.js" as="script"><link rel="preload" href="/assets/js/23.5ae06d94.js" as="script"><link rel="preload" href="/assets/js/3.90399333.js" as="script"><link rel="prefetch" href="/assets/js/10.87145463.js"><link rel="prefetch" href="/assets/js/11.1918620a.js"><link rel="prefetch" href="/assets/js/12.6cce430e.js"><link rel="prefetch" href="/assets/js/13.efa48d13.js"><link rel="prefetch" href="/assets/js/14.27d23835.js"><link rel="prefetch" href="/assets/js/15.6a4bd2a2.js"><link rel="prefetch" href="/assets/js/16.963c7d28.js"><link rel="prefetch" href="/assets/js/17.8e7d945e.js"><link rel="prefetch" href="/assets/js/18.8693db43.js"><link rel="prefetch" href="/assets/js/19.42cce320.js"><link rel="prefetch" href="/assets/js/20.6b2f826c.js"><link rel="prefetch" href="/assets/js/21.54a5a5f4.js"><link rel="prefetch" href="/assets/js/22.1380ca7e.js"><link rel="prefetch" href="/assets/js/24.30ae2ad2.js"><link rel="prefetch" href="/assets/js/25.b5403e58.js"><link rel="prefetch" href="/assets/js/26.f3821ce8.js"><link rel="prefetch" href="/assets/js/27.e332d1a2.js"><link rel="prefetch" href="/assets/js/28.4f0a4b4d.js"><link rel="prefetch" href="/assets/js/29.aa1f0085.js"><link rel="prefetch" href="/assets/js/30.74d62b1b.js"><link rel="prefetch" href="/assets/js/31.0240618c.js"><link rel="prefetch" href="/assets/js/32.5e0c99bc.js"><link rel="prefetch" href="/assets/js/33.9a2cc730.js"><link rel="prefetch" href="/assets/js/34.11a5e517.js"><link rel="prefetch" href="/assets/js/35.30fcd52f.js"><link rel="prefetch" href="/assets/js/36.d92c317f.js"><link rel="prefetch" href="/assets/js/37.48f65213.js"><link rel="prefetch" href="/assets/js/38.4229672d.js"><link rel="prefetch" href="/assets/js/39.9ebbe2e7.js"><link rel="prefetch" href="/assets/js/4.ffd4e858.js"><link rel="prefetch" href="/assets/js/40.2062c717.js"><link rel="prefetch" href="/assets/js/41.f083e3b3.js"><link rel="prefetch" href="/assets/js/42.d9c0e07c.js"><link rel="prefetch" href="/assets/js/43.2dd4922c.js"><link rel="prefetch" href="/assets/js/44.f5de393c.js"><link rel="prefetch" href="/assets/js/45.c82cb76e.js"><link rel="prefetch" href="/assets/js/46.65eb29c3.js"><link rel="prefetch" href="/assets/js/47.2ae4fd4e.js"><link rel="prefetch" href="/assets/js/5.0000f2bd.js"><link rel="prefetch" href="/assets/js/7.be7c9864.js"><link rel="prefetch" href="/assets/js/8.e855ae57.js"><link rel="prefetch" href="/assets/js/9.a7df38a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.27faccf6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一朝春诔</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/golang/" class="nav-link">
  golang
</a></li><li class="dropdown-item"><!----> <a href="/backend/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/backend/cplus/" class="nav-link">
  c++
</a></li><li class="dropdown-item"><!----> <a href="/backend/lua/" class="nav-link">
  lua
</a></li><li class="dropdown-item"><!----> <a href="/backend/vba/" class="nav-link">
  vba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link router-link-exact-active router-link-active">
  redis
</a></li><li class="dropdown-item"><!----> <a href="/database/etcd/" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programming/algo/" class="nav-link">
  算法与数据结构
</a></li><li class="dropdown-item"><!----> <a href="/programming/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opersystem/windows/" class="nav-link">
  windows
</a></li><li class="dropdown-item"><!----> <a href="/opersystem/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/goland/" class="nav-link">
  goland
</a></li><li class="dropdown-item"><!----> <a href="/tool/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tool/pycharm/" class="nav-link">
  pycharm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/other/rabbitmq/" class="nav-link">
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/other/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/other/k8s/" class="nav-link">
  k8s
</a></li><li class="dropdown-item"><!----> <a href="/other/workrecord/" class="nav-link">
  工作记录
</a></li><li class="dropdown-item"><!----> <a href="/other/interview/" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/other/other/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jlinzhou" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/golang/" class="nav-link">
  golang
</a></li><li class="dropdown-item"><!----> <a href="/backend/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/backend/cplus/" class="nav-link">
  c++
</a></li><li class="dropdown-item"><!----> <a href="/backend/lua/" class="nav-link">
  lua
</a></li><li class="dropdown-item"><!----> <a href="/backend/vba/" class="nav-link">
  vba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link router-link-exact-active router-link-active">
  redis
</a></li><li class="dropdown-item"><!----> <a href="/database/etcd/" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programming/algo/" class="nav-link">
  算法与数据结构
</a></li><li class="dropdown-item"><!----> <a href="/programming/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opersystem/windows/" class="nav-link">
  windows
</a></li><li class="dropdown-item"><!----> <a href="/opersystem/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/goland/" class="nav-link">
  goland
</a></li><li class="dropdown-item"><!----> <a href="/tool/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tool/pycharm/" class="nav-link">
  pycharm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/other/rabbitmq/" class="nav-link">
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/other/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/other/k8s/" class="nav-link">
  k8s
</a></li><li class="dropdown-item"><!----> <a href="/other/workrecord/" class="nav-link">
  工作记录
</a></li><li class="dropdown-item"><!----> <a href="/other/interview/" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/other/other/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jlinzhou" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/database/redis/" class="active sidebar-link">redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/redis/#redis事物的了解cas-check-and-set-操作实现乐观锁" class="sidebar-link">redis事物的了解CAS(check-and-set 操作实现乐观锁 )?</a></li><li class="sidebar-sub-header"><a href="/database/redis/#redis如何做持久化的？" class="sidebar-link">Redis如何做持久化的？</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h3> <ol><li>缓存</li> <li>共享Session</li> <li>消息队列系统</li> <li>分布式锁</li></ol> <h3 id="单线程的redis为什么快"><a href="#单线程的redis为什么快" class="header-anchor">#</a> 单线程的Redis为什么快</h3> <ol><li>纯内存操作</li> <li>单线程操作，避免了频繁的上下文切换</li> <li>合理高效的数据结构</li> <li>采用了非阻塞I/O多路复用机制</li></ol> <h3 id="redis-的数据结构"><a href="#redis-的数据结构" class="header-anchor">#</a> Redis 的数据结构</h3> <p>字符串String、字典Hash、列表List、集合Set、有序集合SortedSet。</p> <p>Pub/Sub。</p> <h3 id="redis-的数据过期策略"><a href="#redis-的数据过期策略" class="header-anchor">#</a> Redis 的数据过期策略</h3> <p>Redis 中数据过期策略采用定期删除+惰性删除策略</p> <p>时删除策略就发生了一些改变，不在是每次扫描全部的 key 了，而是随机抽取一部分 key 进行检查，这样就降低了对 CPU 资源的损耗，惰性删除策略互补了为检查到的key，基本上满足了所有要求。</p> <h3 id="如何解决-redis-缓存雪崩问题"><a href="#如何解决-redis-缓存雪崩问题" class="header-anchor">#</a> 如何解决 Redis 缓存雪崩问题</h3> <ol><li>使用 Redis 高可用架构：使用 Redis 集群来保证 Redis 服务不会挂掉</li> <li>缓存时间不一致，给缓存的失效时间，加上一个随机值，避免集体失效</li> <li>限流降级策略：有一定的备案，比如个性推荐服务不可用了，换成热点数据推荐服务</li></ol> <h2 id="redis事物的了解cas-check-and-set-操作实现乐观锁"><a href="#redis事物的了解cas-check-and-set-操作实现乐观锁" class="header-anchor">#</a> redis事物的了解CAS(check-and-set 操作实现乐观锁 )?</h2> <p>和众多其它数据库一样，Redis作为NoSQL数据库也同样提供了事务机制。在Redis中，MULTI/EXEC/DISCARD/WATCH这四个命令是我们实现事务的基石。</p> <h2 id="redis如何做持久化的？"><a href="#redis如何做持久化的？" class="header-anchor">#</a> Redis如何做持久化的？</h2> <ol><li><p>RDB做镜像全量持久化，AOF做增量持久化。
RDB持久化也分两种：SAVE和BGSAVE。</p> <p>SAVE是阻塞式的RDB持久化，当执行这个命令时redis的主进程把内存里的数据库状态写入到RDB文件中，直到该文件创建完毕的这段时间内redis将不能处理任何命令请求；
BGSAVE属于非阻塞式的持久化，它会创建一个子进程专门去把内存中的数据库状态写入RDB文件里，同时主进程还可以处理来自客户端的命令请求。但子进程基本是复制的父进程，这等于两个相同大小的redis进程在系统上运行，会造成内存使用率的大幅增加。</p> <p>fork是指redis通过创建子进程来进行bgsave操作，cow指的是copy on write，子进程创建后，父子进程共享数据段，父进程继续提供读写服务，写脏的页面数据会逐渐和子进程分离开来。</p></li> <li><p>AOF的持久化 把所有的对Redis的服务器进行修改的命令都存到一个文件里，命令的集合。</p></li></ol> <h3 id="redis与mysql双写一致性方案"><a href="#redis与mysql双写一致性方案" class="header-anchor">#</a> Redis与Mysql双写一致性方案</h3> <p>(先更新数据库，再删缓存。数据库的读操作的速度远快于写操作的，所以脏数据很难出现。可以对异步延时删除策略，保证读请求完成以后，再进行删除操作。)</p> <p>https://zhuanlan.zhihu.com/p/59167071</p> <p>不管是先写MySQL数据库，再删除Redis缓存；还是先删除缓存，再写库，都有可能出现数据不一致的情况。举一个例子：</p> <p>1.如果删除了缓存Redis，还没有来得及写库MySQL，另一个线程就来读取，发现缓存为空，则去数据库中读取数据写入缓存，此时缓存中为脏数据。</p> <p>2.如果先写了库，在删除缓存前，写库的线程宕机了，没有删除掉缓存，则也会出现数据不一致情况。</p> <p><strong>延时双删策略</strong></p> <p><strong>具体的步骤就是：</strong></p> <p>1）先删除缓存；</p> <p>2）再写数据库；</p> <p>3）休眠500毫秒；</p> <p>4）再次删除缓存。</p> <p><strong>从Redis缓存读数据流程</strong></p> <p><img src="https://upload-images.jianshu.io/upload_images/15069341-2e0dda38b2c3b1a6.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/553/format/webp" alt=""></p> <h3 id="redis并发竞争key的解决方案"><a href="#redis并发竞争key的解决方案" class="header-anchor">#</a> Redis并发竞争key的解决方案</h3> <ol><li><p>分布式锁+时间戳</p></li> <li><p>利用消息队列</p> <p>分布式锁: 先拿setnx来争抢锁，抢到之后，再用expire给锁加一个过期时间防止锁忘记了释放。</p></li></ol> <h3 id="redis的管道pipeline"><a href="#redis的管道pipeline" class="header-anchor">#</a> Redis的管道pipeline</h3> <p>对于单线程阻塞式的Redis，Pipeline可以满足批量的操作，把多个命令连续的发送给Redis Server，然后一一解析响应结果。Pipelining可以提高批量处理性能，提升的原因主要是TCP连接中减少了“交互往返”的时间。pipeline 底层是通过把所有的操作封装成流，redis有定义自己的出入输出流。在 sync() 方法执行操作，每次请求放在队列里面，解析响应包。</p> <h3 id="redis和memcached的区别"><a href="#redis和memcached的区别" class="header-anchor">#</a> Redis和memcached的区别</h3> <ol><li>存储方式上：memcache会把数据全部存在内存之中，断电后会挂掉，数据不能超过内存大小。redis有部分数据存在硬盘上，这样能保证数据的持久性。</li> <li>数据支持类型上：memcache对数据类型的支持简单，只支持简单的key-value，，而redis支持五种数据类型。</li> <li>用底层模型不同：它们之间底层实现方式以及与客户端之间通信的应用协议不一样。redis直接自己构建了VM机制，因为一般的系统调用系统函数的话，会浪费一定的时间去移动和请求。</li> <li>value的大小：redis可以达到1GB，而memcache只有1MB。</li></ol> <h3 id="skiplist与平衡树、哈希表的比较"><a href="#skiplist与平衡树、哈希表的比较" class="header-anchor">#</a> skiplist与平衡树、哈希表的比较</h3> <ul><li>skiplist和各种平衡树（如AVL、红黑树等）的元素是有序排列的，而哈希表不是有序的。因此，在哈希表上只能做单个key的查找，不适宜做范围查找。所谓范围查找，指的是查找那些大小在指定的两个值之间的所有节点。</li> <li>在做范围查找的时候，平衡树比skiplist操作要复杂。在平衡树上，我们找到指定范围的小值之后，还需要以中序遍历的顺序继续寻找其它不超过大值的节点。如果不对平衡树进行一定的改造，这里的中序遍历并不容易实现。而在skiplist上进行范围查找就非常简单，只需要在找到小值之后，对第1层链表进行若干步的遍历就可以实现。</li> <li>平衡树的插入和删除操作可能引发子树的调整，逻辑复杂，而skiplist的插入和删除只需要修改相邻节点的指针，操作简单又快速。</li> <li>从内存占用上来说，skiplist比平衡树更灵活一些。一般来说，平衡树每个节点包含2个指针（分别指向左右子树），而skiplist每个节点包含的指针数目平均为1/(1-p)，具体取决于参数p的大小。如果像Redis里的实现一样，取p=1/4，那么平均每个节点包含1.33个指针，比平衡树更有优势。</li> <li>查找单个key，skiplist和平衡树的时间复杂度都为O(log n)，大体相当；而哈希表在保持较低的哈希值冲突概率的前提下，查找时间复杂度接近O(1)，性能更高一些。所以我们平常使用的各种Map或dictionary结构，大都是基于哈希表实现的。</li> <li>从算法实现难度上来比较，skiplist比平衡树要简单得多。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020年4月19日星期日下午12点32分</span></div></footer> <!---->  <!----></main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.dc260280.js" defer></script><script src="/assets/js/6.a4c4b5d6.js" defer></script><script src="/assets/js/2.1492d491.js" defer></script><script src="/assets/js/23.5ae06d94.js" defer></script><script src="/assets/js/3.90399333.js" defer></script>
  </body>
</html>
