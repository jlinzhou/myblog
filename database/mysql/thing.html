<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事务 | 一朝春诔</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="assets/img/favicon.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <meta name="description" content="一朝春诔的学习笔记">
    <meta name="author" content="一朝春诔">
    <meta name="keywords" content="vuepress介绍，vuepress说明，一朝春诔">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.27faccf6.css" as="style"><link rel="preload" href="/assets/js/app.27b9f4ed.js" as="script"><link rel="preload" href="/assets/js/6.a4c4b5d6.js" as="script"><link rel="preload" href="/assets/js/2.1492d491.js" as="script"><link rel="preload" href="/assets/js/26.59c4ff75.js" as="script"><link rel="preload" href="/assets/js/3.90399333.js" as="script"><link rel="prefetch" href="/assets/js/10.87145463.js"><link rel="prefetch" href="/assets/js/11.221fba97.js"><link rel="prefetch" href="/assets/js/12.6d618a9e.js"><link rel="prefetch" href="/assets/js/13.5621dfa6.js"><link rel="prefetch" href="/assets/js/14.2ec4739f.js"><link rel="prefetch" href="/assets/js/15.7978d65f.js"><link rel="prefetch" href="/assets/js/16.a4bbafb3.js"><link rel="prefetch" href="/assets/js/17.155e45f3.js"><link rel="prefetch" href="/assets/js/18.1e424122.js"><link rel="prefetch" href="/assets/js/19.ba302dd1.js"><link rel="prefetch" href="/assets/js/20.9a4ebae3.js"><link rel="prefetch" href="/assets/js/21.9f481994.js"><link rel="prefetch" href="/assets/js/22.100055d7.js"><link rel="prefetch" href="/assets/js/23.d2447aea.js"><link rel="prefetch" href="/assets/js/24.28bff12b.js"><link rel="prefetch" href="/assets/js/25.3fbec856.js"><link rel="prefetch" href="/assets/js/27.9553aeb5.js"><link rel="prefetch" href="/assets/js/28.20bad81c.js"><link rel="prefetch" href="/assets/js/29.b3f96c7b.js"><link rel="prefetch" href="/assets/js/30.85ff35d9.js"><link rel="prefetch" href="/assets/js/31.34457343.js"><link rel="prefetch" href="/assets/js/32.d29e33a7.js"><link rel="prefetch" href="/assets/js/33.7f0bb146.js"><link rel="prefetch" href="/assets/js/34.f628d425.js"><link rel="prefetch" href="/assets/js/35.8da0a2e7.js"><link rel="prefetch" href="/assets/js/36.886317b1.js"><link rel="prefetch" href="/assets/js/37.32c5abff.js"><link rel="prefetch" href="/assets/js/38.5c38d261.js"><link rel="prefetch" href="/assets/js/39.6e003123.js"><link rel="prefetch" href="/assets/js/4.9afa6061.js"><link rel="prefetch" href="/assets/js/40.ec5c04a8.js"><link rel="prefetch" href="/assets/js/41.a8ace955.js"><link rel="prefetch" href="/assets/js/42.54abc729.js"><link rel="prefetch" href="/assets/js/43.c6d0b564.js"><link rel="prefetch" href="/assets/js/44.6174cfcf.js"><link rel="prefetch" href="/assets/js/45.09f6dca3.js"><link rel="prefetch" href="/assets/js/46.da2e383b.js"><link rel="prefetch" href="/assets/js/47.63973a6e.js"><link rel="prefetch" href="/assets/js/48.dfd70d39.js"><link rel="prefetch" href="/assets/js/49.54fd64f2.js"><link rel="prefetch" href="/assets/js/5.e99d3266.js"><link rel="prefetch" href="/assets/js/50.a7cbc80a.js"><link rel="prefetch" href="/assets/js/51.0e2ca6d1.js"><link rel="prefetch" href="/assets/js/7.be7c9864.js"><link rel="prefetch" href="/assets/js/8.e855ae57.js"><link rel="prefetch" href="/assets/js/9.a7df38a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.27faccf6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一朝春诔</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/golang/" class="nav-link">
  golang
</a></li><li class="dropdown-item"><!----> <a href="/backend/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/backend/cplus/" class="nav-link">
  c++
</a></li><li class="dropdown-item"><!----> <a href="/backend/lua/" class="nav-link">
  lua
</a></li><li class="dropdown-item"><!----> <a href="/backend/vba/" class="nav-link">
  vba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link router-link-active">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">
  redis
</a></li><li class="dropdown-item"><!----> <a href="/database/etcd/" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programming/algo/" class="nav-link">
  算法与数据结构
</a></li><li class="dropdown-item"><!----> <a href="/programming/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opersystem/windows/" class="nav-link">
  windows
</a></li><li class="dropdown-item"><!----> <a href="/opersystem/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/goland/" class="nav-link">
  goland
</a></li><li class="dropdown-item"><!----> <a href="/tool/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tool/pycharm/" class="nav-link">
  pycharm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/other/rabbitmq/" class="nav-link">
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/other/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/other/k8s/" class="nav-link">
  k8s
</a></li><li class="dropdown-item"><!----> <a href="/other/workrecord/" class="nav-link">
  工作记录
</a></li><li class="dropdown-item"><!----> <a href="/other/interview/" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/other/other/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jlinzhou" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/golang/" class="nav-link">
  golang
</a></li><li class="dropdown-item"><!----> <a href="/backend/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/backend/cplus/" class="nav-link">
  c++
</a></li><li class="dropdown-item"><!----> <a href="/backend/lua/" class="nav-link">
  lua
</a></li><li class="dropdown-item"><!----> <a href="/backend/vba/" class="nav-link">
  vba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link router-link-active">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">
  redis
</a></li><li class="dropdown-item"><!----> <a href="/database/etcd/" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programming/algo/" class="nav-link">
  算法与数据结构
</a></li><li class="dropdown-item"><!----> <a href="/programming/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opersystem/windows/" class="nav-link">
  windows
</a></li><li class="dropdown-item"><!----> <a href="/opersystem/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/goland/" class="nav-link">
  goland
</a></li><li class="dropdown-item"><!----> <a href="/tool/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tool/pycharm/" class="nav-link">
  pycharm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/other/rabbitmq/" class="nav-link">
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/other/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/other/k8s/" class="nav-link">
  k8s
</a></li><li class="dropdown-item"><!----> <a href="/other/workrecord/" class="nav-link">
  工作记录
</a></li><li class="dropdown-item"><!----> <a href="/other/interview/" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/other/other/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jlinzhou" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>mysql</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/database/mysql/" class="sidebar-link">mysql</a></li><li><a href="/database/mysql/lock.html" class="sidebar-link">锁</a></li><li><a href="/database/mysql/split.html" class="sidebar-link">分表分库</a></li><li><a href="/database/mysql/thing.html" class="active sidebar-link">事务</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="事务的基本要素-acid"><a href="#事务的基本要素-acid" class="header-anchor">#</a> 事务的基本要素(ACID)</h3> <ol><li>原子性(Atomicity)：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行</li> <li>一致性(Consistency)：事务开始前和结束后，数据库的完整性约束没有被破坏。</li> <li>隔离性(Isolation)：同一时间，只允许一个事务请求同一数据，不同的事务之间彼此没有任何干扰。</li> <li>持久性(Durability)：事务完成后，事务对数据库的所有更新将被保存到数据库，不能回滚。</li></ol> <h3 id="事务的并发问题"><a href="#事务的并发问题" class="header-anchor">#</a> 事务的并发问题</h3> <ol><li><strong>脏读</strong>：事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据</li> <li><strong>不可重复读</strong>：事务A多次读取同一数据，事务B在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果不一致。</li> <li><strong>幻读</strong>：A事务读取了B事务已经提交的新增数据。注意和不可重复读的区别，这里是新增，不可重复读是更改（或删除）。select某记录是否存在，不存在，准备插入此记录，但执行 insert 时发现此记录已存在，无法插入，此时就发生了幻读。</li></ol> <h3 id="mysql事务隔离级别"><a href="#mysql事务隔离级别" class="header-anchor">#</a> MySQL事务隔离级别</h3> <table><thead><tr><th>事务隔离级别</th> <th>脏读</th> <th>不可重复读</th> <th>幻读</th></tr></thead> <tbody><tr><td>读未提交</td> <td>是</td> <td>是</td> <td>是</td></tr> <tr><td>读已提交</td> <td>否</td> <td>是</td> <td>是</td></tr> <tr><td>可重复读</td> <td>否</td> <td>否</td> <td>是</td></tr> <tr><td>串行化</td> <td>否</td> <td>否</td> <td>否</td></tr></tbody></table> <p>在MySQL可重复读的隔离级别中并不是完全解决了幻读的问题，而是解决了读数据情况下的幻读问题。而对于修改的操作依旧存在幻读问题，就是说MVCC对于幻读的解决时不彻底的。 通过索引加锁，间隙锁，next key lock可以解决幻读的问题。（即加共享锁lock in share mode或排他锁 for update）</p> <p>可重复读是 MySQL InnoDB 引擎的默认隔离级别，但是在 MySQL 额外添加了间隙锁（Gap Lock），可以防止幻读。</p> <h3 id="mysql的逻辑结构"><a href="#mysql的逻辑结构" class="header-anchor">#</a> Mysql的逻辑结构</h3> <ul><li>最上层的服务类似其他<strong>CS结构</strong>，比如连接处理，授权处理。</li> <li>第二层是<strong>Mysql的服务层</strong>，包括SQL的解析分析优化，存储过程触发器视图等也在这一层实现。</li> <li>最后一层是<strong>存储引擎的实现</strong>，类似于Java接口的实现，Mysql的执行器在执行SQL的时候只会关注API的调用，完全屏蔽了不同引擎实现间的差异。比如Select语句，先会判断当前用户是否拥有权限，其次到缓存（内存）查询是否有相应的结果集，如果没有再执行解析sql，优化生成执行计划，调用API执行。</li></ul> <h3 id="sql执行顺序"><a href="#sql执行顺序" class="header-anchor">#</a> SQL执行顺序</h3> <p>SQL的执行顺序：from---where--group by---having---select---order by</p> <h3 id="mvcc简介"><a href="#mvcc简介" class="header-anchor">#</a> MVCC简介</h3> <ol><li><p>什么是MVCC
MVCC是一种<strong>多版本并发控制机制</strong>。</p></li> <li><p>MVCC是为了解决什么问题?
大多数的MYSQL事务型存储引擎,如,InnoDB，Falcon以及PBXT都不使用一种简单的行锁机制.事实上,他们都和MVCC–多版本并发控制来一起使用.
大家都应该知道,<strong>锁机制可以控制并发操作,但是其系统开销较大,而MVCC可以在大多数情况下代替行级锁,使用MVCC,能降低其系统开销.</strong></p></li> <li><p>MVCC实现
<strong>MVCC是通过保存数据在某个时间点的快照来实现的</strong>. 不同存储引擎的MVCC. 不同存储引擎的MVCC实现是不同的,典型的有<strong>乐观并发控制和悲观并发控制</strong>。在Mysql的InnoDB引擎中就是指在<strong>已提交读</strong>(READ COMMITTD)和<strong>可重复读</strong>(REPEATABLE READ)这两种隔离级别下的事务对于SELECT操作会访问版本链中的记录的过程。</p></li> <li><p>MVCC 具体实现分析
下面,我们通过InnoDB的MVCC实现来分析MVCC使怎样进行并发控制的.
InnoDB的MVCC，是通过在每行记录后面保存<strong>两个隐藏的列</strong>来实现的.</p> <p>1.DATA_TRX_ID表示最近修改该行数据的**事务ID **</p> <p>2.DATA_ROLL_PTR则表示指向<strong>该行回滚段的指针</strong>，该行上所有旧的版本，在undo中都通过链表的形式组织，而该值，正式指向undo中该行的历史记录链表</p> <p>(这两个列，分别保存了这个行的<strong>创建时间</strong>，一个保存的是行的<strong>删除时间</strong>。这里存储的并不是实际的时间值,而是系统版本号(可以理解为事务的ID)，每开始一个新的事务，系统版本号就会自动递增，事务开始时刻的系统版本号会作为事务的ID.下面看一下在REPEATABLE READ隔离级别下,MVCC具体是如何操作的.)</p> <p>原文链接：https://blog.csdn.net/whoamiyang/article/details/51901888</p></li></ol> <p><strong>undoLog</strong> 也就是我们常说的回滚日志文件 主要用于事务中执行失败，进行回滚</p> <p><strong>redoLog</strong> 是重做日志文件是记录数据修改之后的值，用于持久化到磁盘中</p> <p><strong>binlog</strong>由Mysql的Server层实现,是逻辑日志,记录的是sql语句的原始逻辑</p> <h3 id="innodb的行锁模式"><a href="#innodb的行锁模式" class="header-anchor">#</a> InnoDB的行锁模式</h3> <p>​	共享锁为读锁，只用于表级 ，本次事务可以读不能写，其他事务只能读。 lock in share mode.</p> <p>​	排他锁为写锁， 用于行级 ，本次事务可以读可以写，其他事务增删改查都不行。 for update .</p> <h3 id="mysql如何保证一致性和持久性"><a href="#mysql如何保证一致性和持久性" class="header-anchor">#</a> Mysql如何保证一致性和持久性</h3> <p>MySQL为了保证ACID中的一致性和持久性，使用了WAL(Write-Ahead Logging,<strong>先写日志再写磁盘</strong>)。Redo log就是一种WAL的应用。当数据库忽然掉电，再重新启动时，MySQL可以通过Redo log还原数据。也就是说，每次事务提交时，不用同步刷新磁盘数据文件，只需要同步刷新Redo log就足够了。</p> <h3 id="为什么选择b-树作为索引结构"><a href="#为什么选择b-树作为索引结构" class="header-anchor">#</a> 为什么选择B+树作为索引结构</h3> <ul><li>Hash索引：Hash索引底层是哈希表，哈希表是一种以key-value存储数据的结构，所以多个数据在存储关系上是完全没有任何顺序关系的，所以，对于<strong>区间查询是无法直接通过索引查询的</strong>，就需要全表扫描。所以，哈希索引只适用于等值查询的场景。而B+ 树是一种<strong>多路平衡查询树，所以他的节点是天然有序的</strong>（左子节点小于父节点、父节点小于右子节点），所以对于范围查询的时候不需要做全表扫描</li> <li>二叉查找树：<strong>解决了排序的基本问题</strong>，但是由于<strong>无法保证平衡</strong>，可能退化为链表。</li> <li>平衡二叉树：<strong>通过旋转解决了平衡的问题</strong>，但是<strong>旋转操作效率太低</strong>。</li> <li>红黑树：通过舍弃严格的平衡和引入红黑节点，解决了	<strong>AVL旋转效率过低</strong>的问题，但是在磁盘等场景下，<strong>树仍然太高，IO次数太多</strong>。</li> <li>B+树：在B树的基础上，将<strong>非叶节点改造为不存储数据纯索引节点</strong>，进一步<strong>降低了树的高度</strong>；此外将<strong>叶节点使用指针连接成链表</strong>，范围查询更加高效。</li></ul> <h3 id="b-树的叶子节点都可以存哪些东西"><a href="#b-树的叶子节点都可以存哪些东西" class="header-anchor">#</a> B+树的叶子节点都可以存哪些东西</h3> <p>(可能存储的是整行数据，也有可能是主键的值。B+树的叶子节点存储了整行数据的是主键索引，也被称之为聚簇索引。而索引B+ Tree的叶子节点存储了主键的值的是非主键索引，也被称之为非聚簇索引)</p> <h3 id="覆盖索引"><a href="#覆盖索引" class="header-anchor">#</a> 覆盖索引</h3> <p>指一个查询语句的执行只用从索引中就能够取得，不必从数据表中读取。也可以称之为实现了索引覆盖。</p> <p>**索引包含所有满足查询需要的数据的索引 **</p> <h3 id="查询在什么时候不走（预期中的）索引"><a href="#查询在什么时候不走（预期中的）索引" class="header-anchor">#</a> 查询在什么时候不走（预期中的）索引</h3> <p>​	like、不等于、参与计算、对null判断、or没有索引、查询集过大、非最左前缀</p> <ol><li>模糊查询 %like</li> <li>索引列参与计算,使用了函数</li> <li>非最左前缀顺序</li> <li>where对null判断</li> <li>where不等于</li> <li>or操作有至少一个字段没有索引</li> <li>需要回表的查询结果集过大（超过配置的范围）</li></ol> <h3 id="什么是最左前缀原则"><a href="#什么是最左前缀原则" class="header-anchor">#</a> 什么是最左前缀原则</h3> <p>MySQL中的索引可以以一定顺序引用多列，这种索引叫作联合索引。如User表的name和city加联合索引就是(name,city)，而最左前缀原则指的是，如果查询的时候查询条件精确匹配索引的左边连续一列或几列，则此列就可以被用到。如下：</p> <div class="language-mysql extra-class"><pre class="language-text"><code>select * from user where name=xx and city=xx ; ／／可以命中索引

select * from user where name=xx ; // 可以命中索引

select * from user where city=xx ; // 无法命中索引
</code></pre></div><p>这里需要注意的是，查询的时候如果两个条件都用上了，但是顺序不同，如 city= xx and name ＝xx，那么现在的查询引擎会自动优化为匹配联合索引的顺序，这样是能够命中索引的。</p> <p>由于最左前缀原则，在创建联合索引时，索引字段的顺序需要考虑字段值去重之后的个数，较多的放前面。ORDER BY子句也遵循此规则。</p> <h3 id="数据库优化指南"><a href="#数据库优化指南" class="header-anchor">#</a> 数据库优化指南</h3> <ol><li>创建并使用正确的索引</li> <li>只返回需要的字段</li> <li>减少交互次数（批量提交）</li> <li>设置合理的Fetch Size（数据每次返回给客户端的条数）</li></ol> <h3 id="索引类型"><a href="#索引类型" class="header-anchor">#</a> 索引类型</h3> <p><strong>从逻辑角度</strong></p> <p>1、<strong>主键索引</strong>：主键索引是一种特殊的唯一索引，不允许有空值 ADD PRIMARY KEY</p> <p>2、普通索引或者<strong>单列索引</strong></p> <p>ADD INDEX index_name ( column )<br>
唯一任务是加快对数据的访问速度</p> <p>3、联合索引 ADD INDEX index_name ( )</p> <p>联合索引，对多个字段同时建立索引，最左前缀原则</p> <p>4、<strong>唯一索引</strong></p> <p>ADD UNIQUE
不允许两行具有相同的索引值</p> <p><strong>主键索引和唯一索引的区别：</strong>
(1) 对于主键/unique constraint ， oracle/sql server/mysql等都会自动建立唯一索引；
(2) 主键不一定只包含一个字段，所以在主键的其中一个字段建<code>唯一索引</code>还是有必要的；
(3) 主键<code>可作外键</code>，唯一索引不可；
(4) 主键<code>不可为空</code>，唯一索引可；
(5) 主键<code>可是多个字段的组合</code>；
(6) 主键与唯一索引不同的是：
a.有<code>not null</code>属性；
b.每个表<code>只能有一个</code>。
(7) 主键索引一定是唯一索引， <code>唯一索引不是主键索引</code>
(8) 主键<code>可以与外键 构成 参照完整性约束</code>， <code>防止数据不一致</code></p> <h3 id="mongodb的使用场景"><a href="#mongodb的使用场景" class="header-anchor">#</a> MongoDB的使用场景</h3> <p>MongoDB目前只支持单文档事务，需要复杂事务支持的场景暂时不适合；只支持行级的事务，或者说支持原子性，单行的操作要么全部成功，要么全部失败。</p> <p>MongoDB的使用场景：
1.敏捷开发。新应用，需求会变，适合字段变动很多的业务，数据模型无法确定，想快速迭代开发，MongoDB没有固定的Schema，所有花在提交、沟通和实施Schema变更的时间都生下来了。
2.不需要事务及复杂 join 支持,例如日志等
3.更高的写入负载
MongoDB侧重高数据写入的性能，而非事务安全，适合业务系统中有大量“低价值”数据的场景。本身存的就是json格式数据。例如做日志系统。
4.数据量很大或者将来会变得很大
Mysql单表数据量达到5-10G时会出现明显的性能降级，需要做数据的水平和垂直拆分、库的拆分完成扩展，MongoDB内建了sharding、很多数据分片的特性，容易水平扩展，比较好的适应大数据量增长的需求。
5.NoSQL适合存储非结构化数据，如文章、评论
6.高可用性
自带高可用，自动主从切换（副本集）</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020年5月6日星期三晚上9点47分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/database/mysql/split.html" class="prev">
        分表分库
      </a></span> <!----></p></div>  <!----></main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.27b9f4ed.js" defer></script><script src="/assets/js/6.a4c4b5d6.js" defer></script><script src="/assets/js/2.1492d491.js" defer></script><script src="/assets/js/26.59c4ff75.js" defer></script><script src="/assets/js/3.90399333.js" defer></script>
  </body>
</html>
