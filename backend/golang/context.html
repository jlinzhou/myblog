<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>context | 一朝春诔</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="assets/img/favicon.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <meta name="description" content="一朝春诔的学习笔记">
    <meta name="author" content="一朝春诔">
    <meta name="keywords" content="vuepress介绍，vuepress说明，一朝春诔">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.27faccf6.css" as="style"><link rel="preload" href="/assets/js/app.a66aae4d.js" as="script"><link rel="preload" href="/assets/js/6.a4c4b5d6.js" as="script"><link rel="preload" href="/assets/js/2.1492d491.js" as="script"><link rel="preload" href="/assets/js/11.221fba97.js" as="script"><link rel="preload" href="/assets/js/3.90399333.js" as="script"><link rel="prefetch" href="/assets/js/10.87145463.js"><link rel="prefetch" href="/assets/js/12.27a5f108.js"><link rel="prefetch" href="/assets/js/13.5621dfa6.js"><link rel="prefetch" href="/assets/js/14.2ec4739f.js"><link rel="prefetch" href="/assets/js/15.7978d65f.js"><link rel="prefetch" href="/assets/js/16.a4bbafb3.js"><link rel="prefetch" href="/assets/js/17.155e45f3.js"><link rel="prefetch" href="/assets/js/18.1e424122.js"><link rel="prefetch" href="/assets/js/19.ba302dd1.js"><link rel="prefetch" href="/assets/js/20.9a4ebae3.js"><link rel="prefetch" href="/assets/js/21.9f481994.js"><link rel="prefetch" href="/assets/js/22.100055d7.js"><link rel="prefetch" href="/assets/js/23.d2447aea.js"><link rel="prefetch" href="/assets/js/24.28bff12b.js"><link rel="prefetch" href="/assets/js/25.3fbec856.js"><link rel="prefetch" href="/assets/js/26.81678017.js"><link rel="prefetch" href="/assets/js/27.9553aeb5.js"><link rel="prefetch" href="/assets/js/28.20bad81c.js"><link rel="prefetch" href="/assets/js/29.546d8330.js"><link rel="prefetch" href="/assets/js/30.eee9b488.js"><link rel="prefetch" href="/assets/js/31.65f3c543.js"><link rel="prefetch" href="/assets/js/32.5f68053f.js"><link rel="prefetch" href="/assets/js/33.0bf56d2e.js"><link rel="prefetch" href="/assets/js/34.d6d80189.js"><link rel="prefetch" href="/assets/js/35.f3ff4153.js"><link rel="prefetch" href="/assets/js/36.c5fd04c3.js"><link rel="prefetch" href="/assets/js/37.d7b7b1f9.js"><link rel="prefetch" href="/assets/js/38.4719b4ca.js"><link rel="prefetch" href="/assets/js/39.2522358a.js"><link rel="prefetch" href="/assets/js/4.aad59b1d.js"><link rel="prefetch" href="/assets/js/40.774b3cb8.js"><link rel="prefetch" href="/assets/js/41.4efb16b3.js"><link rel="prefetch" href="/assets/js/42.0fd17189.js"><link rel="prefetch" href="/assets/js/43.4ef4700c.js"><link rel="prefetch" href="/assets/js/44.c45cc724.js"><link rel="prefetch" href="/assets/js/45.72111d16.js"><link rel="prefetch" href="/assets/js/46.461d4aff.js"><link rel="prefetch" href="/assets/js/47.fbe54eab.js"><link rel="prefetch" href="/assets/js/48.fc4b148f.js"><link rel="prefetch" href="/assets/js/49.06c8d64e.js"><link rel="prefetch" href="/assets/js/5.4a914c9f.js"><link rel="prefetch" href="/assets/js/50.5e3c9882.js"><link rel="prefetch" href="/assets/js/51.1b94d243.js"><link rel="prefetch" href="/assets/js/52.c4b8363e.js"><link rel="prefetch" href="/assets/js/53.57f1fe6d.js"><link rel="prefetch" href="/assets/js/7.be7c9864.js"><link rel="prefetch" href="/assets/js/8.e855ae57.js"><link rel="prefetch" href="/assets/js/9.a7df38a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.27faccf6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一朝春诔</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/golang/" class="nav-link router-link-active">
  golang
</a></li><li class="dropdown-item"><!----> <a href="/backend/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/backend/cplus/" class="nav-link">
  c++
</a></li><li class="dropdown-item"><!----> <a href="/backend/lua/" class="nav-link">
  lua
</a></li><li class="dropdown-item"><!----> <a href="/backend/vba/" class="nav-link">
  vba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">
  redis
</a></li><li class="dropdown-item"><!----> <a href="/database/etcd/" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programming/algo/" class="nav-link">
  算法与数据结构
</a></li><li class="dropdown-item"><!----> <a href="/programming/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opersystem/windows/" class="nav-link">
  windows
</a></li><li class="dropdown-item"><!----> <a href="/opersystem/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/goland/" class="nav-link">
  goland
</a></li><li class="dropdown-item"><!----> <a href="/tool/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tool/pycharm/" class="nav-link">
  pycharm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/other/rabbitmq/" class="nav-link">
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/other/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/other/k8s/" class="nav-link">
  k8s
</a></li><li class="dropdown-item"><!----> <a href="/other/workrecord/" class="nav-link">
  工作记录
</a></li><li class="dropdown-item"><!----> <a href="/other/interview/" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/other/other/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jlinzhou" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/golang/" class="nav-link router-link-active">
  golang
</a></li><li class="dropdown-item"><!----> <a href="/backend/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/backend/cplus/" class="nav-link">
  c++
</a></li><li class="dropdown-item"><!----> <a href="/backend/lua/" class="nav-link">
  lua
</a></li><li class="dropdown-item"><!----> <a href="/backend/vba/" class="nav-link">
  vba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">
  redis
</a></li><li class="dropdown-item"><!----> <a href="/database/etcd/" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programming/algo/" class="nav-link">
  算法与数据结构
</a></li><li class="dropdown-item"><!----> <a href="/programming/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opersystem/windows/" class="nav-link">
  windows
</a></li><li class="dropdown-item"><!----> <a href="/opersystem/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/goland/" class="nav-link">
  goland
</a></li><li class="dropdown-item"><!----> <a href="/tool/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tool/pycharm/" class="nav-link">
  pycharm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/other/rabbitmq/" class="nav-link">
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/other/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/other/k8s/" class="nav-link">
  k8s
</a></li><li class="dropdown-item"><!----> <a href="/other/workrecord/" class="nav-link">
  工作记录
</a></li><li class="dropdown-item"><!----> <a href="/other/interview/" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/other/other/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jlinzhou" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>golang</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/golang/" class="sidebar-link">golang基础</a></li><li><a href="/backend/golang/context.html" class="active sidebar-link">context</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/golang/context.html#总诉" class="sidebar-link">总诉</a></li><li class="sidebar-sub-header"><a href="/backend/golang/context.html#设计原理" class="sidebar-link">设计原理</a></li><li class="sidebar-sub-header"><a href="/backend/golang/context.html#使用-context-同步信号" class="sidebar-link">使用 Context 同步信号</a></li><li class="sidebar-sub-header"><a href="/backend/golang/context.html#context控制多个goroutine" class="sidebar-link">Context控制多个goroutine</a></li><li class="sidebar-sub-header"><a href="/backend/golang/context.html#withvalue传递元数据" class="sidebar-link">WithValue传递元数据</a></li><li class="sidebar-sub-header"><a href="/backend/golang/context.html#context-使用原则" class="sidebar-link">Context 使用原则</a></li></ul></li><li><a href="/backend/golang/coredump.html" class="sidebar-link">go coredump调试笔记</a></li><li><a href="/backend/golang/distributed.html" class="sidebar-link">分布式技术原理</a></li><li><a href="/backend/golang/logrus.html" class="sidebar-link">logrus的使用</a></li><li><a href="/backend/golang/map.html" class="sidebar-link">哈希表</a></li><li><a href="/backend/golang/micro.html" class="sidebar-link">微服务</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="总诉"><a href="#总诉" class="header-anchor">#</a> 总诉</h2> <h2 id="设计原理"><a href="#设计原理" class="header-anchor">#</a> 设计原理</h2> <p>context.Context的作用就是在不同 Goroutine 之间同步请求特定数据、取消信号以及处理请求的截止日期，主要作用还是在多个 Goroutine 组成的树中<strong>同步取消信号</strong>以减少对资源的消耗和占用</p> <p>Deadline() 返回 context.Context被取消的时间</p> <p>Done() 返回一个 Channel，这个 Channel 会在<strong>当前工作完成或者上下文被取消之后</strong>关闭，多次调用 Done方法会返回同一个 Channel</p> <p>Err方法返回取消的错误原因，因为什么Context被取消。</p> <p>Value方法获取该Context上绑定的值，是一个键值对，所以要通过一个Key才可以获取对应的值，这个值一般是线程安全的。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>context包中最常用的方法还是 context.Background、context.TODO、context.WithCancel、context.Context 中衍生出一个新的子上下文并返回用于取消该上下文的函数（CancelFunc）</p> <p>例子:</p> <h2 id="使用-context-同步信号"><a href="#使用-context-同步信号" class="header-anchor">#</a> 使用 Context 同步信号</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">handle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">500</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">handle</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> duration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;handle&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;process request with&quot;</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为过期时间大于处理时间，所以我们有足够的时间处理该『请求』，运行上述代码会打印出如下所示的内容：</p> <div class="language-go extra-class"><pre class="language-go"><code>$ <span class="token keyword">go</span> run context<span class="token punctuation">.</span><span class="token keyword">go</span>
process request with <span class="token number">500</span>ms
main context deadline exceeded
</code></pre></div><p>handle 函数没有进入超时的 select分支，但是 main函数的 select却会等待 context.Context 的超时并打印出main context deadline exceeded。</p> <p>如果我们将处理『请求』时间增加至 1500ms，整个程序都会因为上下文的过期而被中止，：</p> <div class="language-go extra-class"><pre class="language-go"><code>$ <span class="token keyword">go</span> run context<span class="token punctuation">.</span><span class="token keyword">go</span>
main context deadline exceeded
handle context deadline exceeded
</code></pre></div><h2 id="context控制多个goroutine"><a href="#context控制多个goroutine" class="header-anchor">#</a> Context控制多个goroutine</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span><span class="token string">&quot;【监控1】&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span><span class="token string">&quot;【监控2】&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span><span class="token string">&quot;【监控3】&quot;</span><span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;可以了，通知监控停止&quot;</span><span class="token punctuation">)</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//为了检测监控过是否停止，如果没有监控输出，就表示停止了</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">watch</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token string">&quot;监控退出，停止了...&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token string">&quot;goroutine监控中...&quot;</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例中启动了3个监控goroutine进行不断的监控，每一个都使用了Context进行跟踪，当我们使用cancel函数通知取消时，这3个goroutine都会被结束。这就是Context的控制能力，它就像一个控制器一样，按下开关后，所有基于这个Context或者衍生的子Context都会收到通知，这时就可以进行清理操作了，最终释放goroutine，这就优雅的解决了goroutine启动后不可控的问题。</p> <h2 id="withvalue传递元数据"><a href="#withvalue传递元数据" class="header-anchor">#</a> WithValue传递元数据</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> key <span class="token builtin">string</span><span class="token operator">=</span><span class="token string">&quot;name&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//附加值</span>
	valueCtx<span class="token operator">:=</span>context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token string">&quot;【监控1】&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">watch</span><span class="token punctuation">(</span>valueCtx<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;可以了，通知监控停止&quot;</span><span class="token punctuation">)</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//为了检测监控过是否停止，如果没有监控输出，就表示停止了</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">watch</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment">//取出值</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;监控退出，停止了...&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token comment">//取出值</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;goroutine监控中...&quot;</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在前面的例子，我们通过传递参数的方式，把name的值传递给监控函数。在这个例子里，我们实现一样的效果，但是通过的是Context的Value的方式。</p> <p>我们可以使用context.WithValue方法附加一对K-V的键值对，这里Key必须是等价性的，也就是具有可比性；Value值要是线程安全的。</p> <h2 id="context-使用原则"><a href="#context-使用原则" class="header-anchor">#</a> Context 使用原则</h2> <ol><li>不要把Context放在结构体中，要以参数的方式传递</li> <li>以Context作为参数的函数方法，应该把Context作为第一个参数，放在第一位。</li> <li>给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO</li> <li>Context的Value相关方法应该传递必须的数据，不要什么数据都使用这个传递</li> <li>Context是线程安全的，可以放心的在多个goroutine中传递</li></ol> <p><strong>参考资料</strong></p> <p>https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-context/</p> <p>ctx, cancel := context.WithCancel(context.Background())</p> <p>valueCtx:=context.WithValue(ctx,key,&quot;【监控1】&quot;)</p> <p>ctx.Value(key)</p> <p>cancel()</p> <p>ctx.Done()</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020年4月28日星期二早上8点29分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backend/golang/" class="prev router-link-active">
        golang基础
      </a></span> <span class="next"><a href="/backend/golang/coredump.html">
        go coredump调试笔记
      </a>
      →
    </span></p></div>  <!----></main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.a66aae4d.js" defer></script><script src="/assets/js/6.a4c4b5d6.js" defer></script><script src="/assets/js/2.1492d491.js" defer></script><script src="/assets/js/11.221fba97.js" defer></script><script src="/assets/js/3.90399333.js" defer></script>
  </body>
</html>
