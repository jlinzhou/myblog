<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>logrus的使用 | 一朝春诔</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="assets/img/favicon.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <meta name="description" content="一朝春诔的学习笔记">
    <meta name="author" content="一朝春诔">
    <meta name="keywords" content="vuepress介绍，vuepress说明，一朝春诔">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.27faccf6.css" as="style"><link rel="preload" href="/assets/js/app.ee61cafb.js" as="script"><link rel="preload" href="/assets/js/6.a4c4b5d6.js" as="script"><link rel="preload" href="/assets/js/2.1492d491.js" as="script"><link rel="preload" href="/assets/js/14.2ec4739f.js" as="script"><link rel="preload" href="/assets/js/3.90399333.js" as="script"><link rel="prefetch" href="/assets/js/10.c2c14d05.js"><link rel="prefetch" href="/assets/js/11.1392f518.js"><link rel="prefetch" href="/assets/js/12.6d618a9e.js"><link rel="prefetch" href="/assets/js/13.5621dfa6.js"><link rel="prefetch" href="/assets/js/15.7978d65f.js"><link rel="prefetch" href="/assets/js/16.a4bbafb3.js"><link rel="prefetch" href="/assets/js/17.155e45f3.js"><link rel="prefetch" href="/assets/js/18.1e424122.js"><link rel="prefetch" href="/assets/js/19.ba302dd1.js"><link rel="prefetch" href="/assets/js/20.9a4ebae3.js"><link rel="prefetch" href="/assets/js/21.9f481994.js"><link rel="prefetch" href="/assets/js/22.100055d7.js"><link rel="prefetch" href="/assets/js/23.d2447aea.js"><link rel="prefetch" href="/assets/js/24.28bff12b.js"><link rel="prefetch" href="/assets/js/25.3fbec856.js"><link rel="prefetch" href="/assets/js/26.59c4ff75.js"><link rel="prefetch" href="/assets/js/27.9553aeb5.js"><link rel="prefetch" href="/assets/js/28.20bad81c.js"><link rel="prefetch" href="/assets/js/29.b3f96c7b.js"><link rel="prefetch" href="/assets/js/30.85ff35d9.js"><link rel="prefetch" href="/assets/js/31.34457343.js"><link rel="prefetch" href="/assets/js/32.d29e33a7.js"><link rel="prefetch" href="/assets/js/33.7f0bb146.js"><link rel="prefetch" href="/assets/js/34.22f42eb7.js"><link rel="prefetch" href="/assets/js/35.8da0a2e7.js"><link rel="prefetch" href="/assets/js/36.886317b1.js"><link rel="prefetch" href="/assets/js/37.3b7af4a8.js"><link rel="prefetch" href="/assets/js/38.5c38d261.js"><link rel="prefetch" href="/assets/js/39.6e003123.js"><link rel="prefetch" href="/assets/js/4.9afa6061.js"><link rel="prefetch" href="/assets/js/40.ec5c04a8.js"><link rel="prefetch" href="/assets/js/41.a8ace955.js"><link rel="prefetch" href="/assets/js/42.54abc729.js"><link rel="prefetch" href="/assets/js/43.c6d0b564.js"><link rel="prefetch" href="/assets/js/44.6174cfcf.js"><link rel="prefetch" href="/assets/js/45.09f6dca3.js"><link rel="prefetch" href="/assets/js/46.da2e383b.js"><link rel="prefetch" href="/assets/js/47.63973a6e.js"><link rel="prefetch" href="/assets/js/48.dfd70d39.js"><link rel="prefetch" href="/assets/js/49.54fd64f2.js"><link rel="prefetch" href="/assets/js/5.e99d3266.js"><link rel="prefetch" href="/assets/js/50.a7cbc80a.js"><link rel="prefetch" href="/assets/js/51.0e2ca6d1.js"><link rel="prefetch" href="/assets/js/7.be7c9864.js"><link rel="prefetch" href="/assets/js/8.e855ae57.js"><link rel="prefetch" href="/assets/js/9.70bf3109.js">
    <link rel="stylesheet" href="/assets/css/0.styles.27faccf6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一朝春诔</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/golang/" class="nav-link router-link-active">
  golang
</a></li><li class="dropdown-item"><!----> <a href="/backend/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/backend/cplus/" class="nav-link">
  c++
</a></li><li class="dropdown-item"><!----> <a href="/backend/lua/" class="nav-link">
  lua
</a></li><li class="dropdown-item"><!----> <a href="/backend/vba/" class="nav-link">
  vba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">
  redis
</a></li><li class="dropdown-item"><!----> <a href="/database/etcd/" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programming/algo/" class="nav-link">
  算法与数据结构
</a></li><li class="dropdown-item"><!----> <a href="/programming/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opersystem/windows/" class="nav-link">
  windows
</a></li><li class="dropdown-item"><!----> <a href="/opersystem/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/goland/" class="nav-link">
  goland
</a></li><li class="dropdown-item"><!----> <a href="/tool/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tool/pycharm/" class="nav-link">
  pycharm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/other/rabbitmq/" class="nav-link">
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/other/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/other/k8s/" class="nav-link">
  k8s
</a></li><li class="dropdown-item"><!----> <a href="/other/workrecord/" class="nav-link">
  工作记录
</a></li><li class="dropdown-item"><!----> <a href="/other/interview/" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/other/other/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jlinzhou" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/golang/" class="nav-link router-link-active">
  golang
</a></li><li class="dropdown-item"><!----> <a href="/backend/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/backend/cplus/" class="nav-link">
  c++
</a></li><li class="dropdown-item"><!----> <a href="/backend/lua/" class="nav-link">
  lua
</a></li><li class="dropdown-item"><!----> <a href="/backend/vba/" class="nav-link">
  vba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">
  redis
</a></li><li class="dropdown-item"><!----> <a href="/database/etcd/" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/programming/algo/" class="nav-link">
  算法与数据结构
</a></li><li class="dropdown-item"><!----> <a href="/programming/pattern/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opersystem/windows/" class="nav-link">
  windows
</a></li><li class="dropdown-item"><!----> <a href="/opersystem/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/tool/goland/" class="nav-link">
  goland
</a></li><li class="dropdown-item"><!----> <a href="/tool/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tool/pycharm/" class="nav-link">
  pycharm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/nginx/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/other/rabbitmq/" class="nav-link">
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/other/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/other/k8s/" class="nav-link">
  k8s
</a></li><li class="dropdown-item"><!----> <a href="/other/workrecord/" class="nav-link">
  工作记录
</a></li><li class="dropdown-item"><!----> <a href="/other/interview/" class="nav-link">
  面试宝典
</a></li><li class="dropdown-item"><!----> <a href="/other/other/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jlinzhou" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>golang</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/golang/" class="sidebar-link">golang基础</a></li><li><a href="/backend/golang/context.html" class="sidebar-link">context</a></li><li><a href="/backend/golang/coredump.html" class="sidebar-link">go coredump调试笔记</a></li><li><a href="/backend/golang/distributed.html" class="sidebar-link">分布式技术原理</a></li><li><a href="/backend/golang/logrus.html" class="active sidebar-link">logrus的使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/backend/golang/map.html" class="sidebar-link">哈希表</a></li><li><a href="/backend/golang/micro.html" class="sidebar-link">微服务</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="特性"><a href="#特性" class="header-anchor">#</a> 特性</h3> <ul><li>六种日志级别：debug、info、warn、error、fatal和panic</li> <li>可扩展的Hook机制：允许使用者通过hook的方式将日志分发到任意地方，如本地文件系统、标准输出、logstash、elasticsearch或者mq等，或者通过hook定义日志内容和格式等。</li> <li>可选的日志输出格式：logrus内置了两种日志格式，JSONFormatter和TextFormatter，如果这两个格式不满足需求，可以自己动手实现接口Formatter，来定义自己的日志格式。</li> <li>Field机制：logrus鼓励通过Field机制进行精细化的、结构化的日志记录，而不是通过冗长的消息来记录日志。</li> <li>logrus是一个可插拔的、结构化的日志框架。</li></ul> <h3 id="简单使用示例"><a href="#简单使用示例" class="header-anchor">#</a> 简单使用示例</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;os&quot;</span>
	log <span class="token string">&quot;github.com/sirupsen/logrus&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 设置日志格式为json格式</span>
	log<span class="token punctuation">.</span><span class="token function">SetFormatter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>JSONFormatter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// 设置将日志输出到标准输出（默认的输出为stderr，标准错误）</span>
	<span class="token comment">// 日志消息输出可以是任意的io.writer类型</span>
	log<span class="token punctuation">.</span><span class="token function">SetOutput</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">)</span>

	<span class="token comment">// 设置日志级别为warn以上</span>
	log<span class="token punctuation">.</span><span class="token function">SetLevel</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>WarnLevel<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>Fields<span class="token punctuation">{</span>
		<span class="token string">&quot;animal&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;walrus&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span>   <span class="token number">10</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;A group of walrus emerges from the ocean&quot;</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>Fields<span class="token punctuation">{</span>
		<span class="token string">&quot;omg&quot;</span><span class="token punctuation">:</span>    <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token string">&quot;number&quot;</span><span class="token punctuation">:</span> <span class="token number">122</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">&quot;The group's number increased tremendously!&quot;</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>Fields<span class="token punctuation">{</span>
		<span class="token string">&quot;omg&quot;</span><span class="token punctuation">:</span>    <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token string">&quot;number&quot;</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;The ice breaks!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="hook"><a href="#hook" class="header-anchor">#</a> Hook</h3> <p>logrus最令人心动的功能就是其可扩展的HOOK机制了，通过在初始化时为logrus添加hook，logrus可以实现各种扩展功能。</p> <p><strong>Hook接口</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// logrus在记录Levels()返回的日志级别的消息时会触发HOOK，</span>
<span class="token comment">// 按照Fire方法定义的内容修改logrus.Entry。</span>
<span class="token keyword">type</span> Hook <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Levels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Level
	<span class="token function">Fire</span><span class="token punctuation">(</span><span class="token operator">*</span>Entry<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个简单自定义hook如下，DefaultFieldHook定义会在所有级别的日志消息中加入默认字段appName=&quot;myAppName&quot;。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> DefaultFieldHook <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>hook <span class="token operator">*</span>DefaultFieldHook<span class="token punctuation">)</span> <span class="token function">Fire</span><span class="token punctuation">(</span>entry <span class="token operator">*</span>log<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    entry<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token string">&quot;appName&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;MyAppName&quot;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>hook <span class="token operator">*</span>DefaultFieldHook<span class="token punctuation">)</span> <span class="token function">Levels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>Level <span class="token punctuation">{</span>
    <span class="token keyword">return</span> log<span class="token punctuation">.</span>AllLevels
<span class="token punctuation">}</span>
</code></pre></div><h3 id="使用hook来生成行号文件名"><a href="#使用hook来生成行号文件名" class="header-anchor">#</a> 使用hook来生成行号文件名</h3> <p>logrus的一个很致命的问题就是没有提供文件名和行号。网上给出的解决方案分位两类，一就是自己实现一个hook；二就是通过装饰器包装logrus.Entry。两种方案网上都有很多代码，但是大多无法正常工作。但总体来说，解决问题的思路都是对的：通过标准库的runtime模块获取运行时信息，并从中提取文件名，行号和调用函数名。
<br>
标准库runtime模块的Caller(skip int)函数可以返回当前goroutine调用栈中的文件名，行号，函数信息等，参数skip表示表示返回的栈帧的层次，0表示runtime.Caller的调用着。返回值包括响应栈帧层次的pc(程序计数器)，文件名和行号信息。为了提高效率，我们先通过跟踪调用栈发现，从runtime.Caller()的调用者开始，到记录日志的生成代码之间，大概有8到11层左右，所有我们在hook中循环第8到11层调用栈应该可以找到日志记录的生产代码。</p> <p>此外，runtime.FuncForPC(pc uintptr) *Func可以返回指定pc的函数信息。
所有我们要实现的hook也是基于以上原理，使用runtime.Caller()依次循环调用栈的第7~11层，过滤掉sirupsen包内容，那么第一个非siupsenr包就认为是我们的生产代码了，并返回pc以便通过runtime.FuncForPC()获取函数名称。然后将文件名、行号和函数名组装为source字段塞到logrus.Entry中即可。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	log <span class="token string">&quot;github.com/sirupsen/logrus&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// line number hook for log the call context,</span>
<span class="token keyword">type</span> lineHook <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Field  <span class="token builtin">string</span>
    <span class="token comment">// skip为遍历调用栈开始的索引位置</span>
	Skip   <span class="token builtin">int</span>
	levels <span class="token punctuation">[</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>Level
<span class="token punctuation">}</span>

<span class="token comment">// Levels implement levels</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>hook lineHook<span class="token punctuation">)</span> <span class="token function">Levels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>Level <span class="token punctuation">{</span>
	<span class="token keyword">return</span> log<span class="token punctuation">.</span>AllLevels
<span class="token punctuation">}</span>

<span class="token comment">// Fire implement fire</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>hook lineHook<span class="token punctuation">)</span> <span class="token function">Fire</span><span class="token punctuation">(</span>entry <span class="token operator">*</span>log<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	entry<span class="token punctuation">.</span>Data<span class="token punctuation">[</span>hook<span class="token punctuation">.</span>Field<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">findCaller</span><span class="token punctuation">(</span>hook<span class="token punctuation">.</span>Skip<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">findCaller</span><span class="token punctuation">(</span>skip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	file <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
	line <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">var</span> pc <span class="token builtin">uintptr</span>
    <span class="token comment">// 遍历调用栈的最大索引为第11层.</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> pc <span class="token operator">=</span> <span class="token function">getCaller</span><span class="token punctuation">(</span>skip <span class="token operator">+</span> i<span class="token punctuation">)</span>
        <span class="token comment">// 过滤掉所有logrus包，即可得到生成代码信息</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;logrus&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	fullFnName <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">FuncForPC</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span>

	fnName <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
	<span class="token keyword">if</span> fullFnName <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fnNameStr <span class="token operator">:=</span> fullFnName<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 取得函数名</span>
		parts <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>fnNameStr<span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
		fnName <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d:%s()&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> fnName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getCaller</span><span class="token punctuation">(</span>skip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pc<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> ok <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Caller</span><span class="token punctuation">(</span>skip<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pc
	<span class="token punctuation">}</span>
	n <span class="token operator">:=</span> <span class="token number">0</span>

    <span class="token comment">// 获取包名</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> file<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
			n<span class="token operator">++</span>
			<span class="token keyword">if</span> n <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
				file <span class="token operator">=</span> file<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> pc
<span class="token punctuation">}</span>
</code></pre></div><h3 id="文件分割"><a href="#文件分割" class="header-anchor">#</a> 文件分割</h3> <p>logrus本身不带日志本地文件分割功能，但是我们可以通过logrus-lumberjack-hook进行日志本地文件分割。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	log <span class="token string">&quot;github.com/sirupsen/logrus&quot;</span>
	<span class="token string">&quot;time&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;github.com/natefinch/lumberjack&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;io&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> LogFilePath <span class="token operator">=</span> <span class="token string">&quot;logs/misc.log&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Setup logger</span>
	lumberjackLogrotate <span class="token operator">:=</span> <span class="token operator">&amp;</span>lumberjack<span class="token punctuation">.</span>Logger<span class="token punctuation">{</span>
		Filename<span class="token punctuation">:</span>   LogFilePath<span class="token punctuation">,</span>
		MaxSize<span class="token punctuation">:</span>    <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token comment">// Max megabytes before log is rotated</span>
		MaxBackups<span class="token punctuation">:</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token comment">// Max number of old log files to keep</span>
		MaxAge<span class="token punctuation">:</span>     <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// Max number of days to retain log files</span>
		Compress<span class="token punctuation">:</span>   <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	log<span class="token punctuation">.</span><span class="token function">SetFormatter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>TextFormatter<span class="token punctuation">{</span>FullTimestamp<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> TimestampFormat<span class="token punctuation">:</span> time<span class="token punctuation">.</span>RFC1123Z<span class="token punctuation">}</span><span class="token punctuation">)</span>

	logMultiWriter <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">MultiWriter</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> lumberjackLogrotate<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">SetOutput</span><span class="token punctuation">(</span>logMultiWriter<span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>Fields<span class="token punctuation">{</span>
		<span class="token string">&quot;Runtime Version&quot;</span><span class="token punctuation">:</span> runtime<span class="token punctuation">.</span><span class="token function">Version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token string">&quot;Number of CPUs&quot;</span><span class="token punctuation">:</span>  runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token string">&quot;Arch&quot;</span><span class="token punctuation">:</span>            runtime<span class="token punctuation">.</span>GOARCH<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Application Initializing&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="formatter"><a href="#formatter" class="header-anchor">#</a> formatter</h3> <p><strong>简单使用</strong>
logrus 通过 formatter 来定义输出日志的格式,具体例子如下:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	log <span class="token string">&quot;github.com/Sirupsen/logrus&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	formatter <span class="token operator">:=</span> <span class="token operator">&amp;</span>log<span class="token punctuation">.</span>TextFormatter<span class="token punctuation">{</span>
    <span class="token comment">// 不需要彩色日志</span>
		DisableColors<span class="token punctuation">:</span>   <span class="token boolean">true</span><span class="token punctuation">,</span> 
    <span class="token comment">// 定义时间戳格式</span>
		TimestampFormat<span class="token punctuation">:</span> <span class="token string">&quot;2006-01-02 15:04:05&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">SetFormatter</span><span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>打印日志如下:</p> <div class="language-go extra-class"><pre class="language-go"><code>time<span class="token operator">=</span><span class="token string">&quot;2019-11-07 17:41:20&quot;</span> level<span class="token operator">=</span>info msg<span class="token operator">=</span><span class="token string">&quot;hello world&quot;</span>
</code></pre></div><p><strong>分析</strong>
本身 formatter 是接口类型,只要实现该结构我们就可以自定义日志输出格式:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Any additional fields added with `WithField` or `WithFields` are also in</span>
<span class="token comment">// `entry.Data`. Format is expected to return an array of bytes which are then</span>
<span class="token comment">// logged to `logger.Out`.</span>
<span class="token keyword">type</span> Formatter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Format</span><span class="token punctuation">(</span><span class="token operator">*</span>Entry<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>logrus 提供了两种默认的日志输出格式, TextFormatter和JSONFormatter.上面的示例使用的就是TextFormatter.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> TextFormatter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Set to true to bypass checking for a TTY before outputting colors.</span>
	ForceColors <span class="token builtin">bool</span>
  <span class="token comment">//不使用彩色日志</span>
	DisableColors <span class="token builtin">bool</span>
	<span class="token comment">// Override coloring based on CLICOLOR and CLICOLOR_FORCE. - https://bixense.com/clicolors/</span>
	EnvironmentOverrideColors <span class="token builtin">bool</span>
  <span class="token comment">// 是否打印时间戳</span>
	DisableTimestamp <span class="token builtin">bool</span>
	<span class="token comment">// Enable logging the full timestamp when a TTY is attached instead of just</span>
  <span class="token comment">// 是否按照时间戳格式打印,置为false则只打印从程序启动到打印日志的时间差(单位:秒)</span>
	FullTimestamp <span class="token builtin">bool</span>
  <span class="token comment">// 时间戳格式</span>
	TimestampFormat <span class="token builtin">string</span>
  <span class="token comment">// 设置 fields 不排序</span>
	DisableSorting <span class="token builtin">bool</span>
  <span class="token comment">// 设置 fields 的排序规则</span>
	SortingFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token comment">// Disables the truncation of the level text to 4 characters.</span>
	DisableLevelTruncation <span class="token builtin">bool</span>
	<span class="token comment">// QuoteEmptyFields will wrap empty fields in quotes if true</span>
	QuoteEmptyFields <span class="token builtin">bool</span>
  <span class="token comment">// 是否打印日志到终端</span>
	isTerminal <span class="token builtin">bool</span>
  <span class="token comment">// fieldMap</span>
	<span class="token comment">// As an example:</span>
	<span class="token comment">// formatter := &amp;TextFormatter{</span>
	<span class="token comment">//     FieldMap: FieldMap{</span>
	<span class="token comment">//         FieldKeyTime:  &quot;@timestamp&quot;,</span>
	<span class="token comment">//         FieldKeyLevel: &quot;@level&quot;,</span>
	<span class="token comment">//         FieldKeyMsg:   &quot;@message&quot;}}</span>
	FieldMap FieldMap
  <span class="token comment">// 设置 func 和 file 这两个 field的输出格式</span>
	CallerPrettyfier <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>runtime<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">(</span>function <span class="token builtin">string</span><span class="token punctuation">,</span> file <span class="token builtin">string</span><span class="token punctuation">)</span>
	terminalInitOnce sync<span class="token punctuation">.</span>Once
<span class="token punctuation">}</span>
</code></pre></div><p>TextFormatter 实现 Formatter接口</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Format renders a single log entry</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>TextFormatter<span class="token punctuation">)</span> <span class="token function">Format</span><span class="token punctuation">(</span>entry <span class="token operator">*</span>Entry<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>Fields<span class="token punctuation">)</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> entry<span class="token punctuation">.</span>Data <span class="token punctuation">{</span>
		data<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>
  <span class="token comment">// prefixFieldClashes 删除默认的 4 个 field,防止冲突(msg, level, time, logrus_error)</span>
	<span class="token function">prefixFieldClashes</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> f<span class="token punctuation">.</span>FieldMap<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">HasCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	keys <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> k <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{</span>
		keys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token comment">// 拼接待打印日志的各个元素</span>
	<span class="token keyword">var</span> funcVal<span class="token punctuation">,</span> fileVal <span class="token builtin">string</span>
<span class="token comment">// 拼接元素过程省略 ...</span>
	f<span class="token punctuation">.</span>terminalInitOnce<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> f<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 修改时间戳</span>
	timestampFormat <span class="token operator">:=</span> f<span class="token punctuation">.</span>TimestampFormat
	<span class="token keyword">if</span> timestampFormat <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		timestampFormat <span class="token operator">=</span> defaultTimestampFormat
	<span class="token punctuation">}</span>
	<span class="token comment">// 以下省略 ...</span>
  <span class="token comment">// 打印换行符</span>
	b<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>JSONFormatter</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// JSONFormatter formats logs into parsable json</span>
<span class="token keyword">type</span> JSONFormatter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// TimestampFormat sets the format used for marshaling timestamps.</span>
	TimestampFormat <span class="token builtin">string</span>

	<span class="token comment">// DisableTimestamp allows disabling automatic timestamps in output</span>
	DisableTimestamp <span class="token builtin">bool</span>

	<span class="token comment">// DataKey allows users to put all the log entry parameters into a nested dictionary at a given key.</span>
	DataKey <span class="token builtin">string</span>

	<span class="token comment">// FieldMap allows users to customize the names of keys for default fields.</span>
	<span class="token comment">// As an example:</span>
	<span class="token comment">// formatter := &amp;JSONFormatter{</span>
	<span class="token comment">//   	FieldMap: FieldMap{</span>
	<span class="token comment">// 		 FieldKeyTime:  &quot;@timestamp&quot;,</span>
	<span class="token comment">// 		 FieldKeyLevel: &quot;@level&quot;,</span>
	<span class="token comment">// 		 FieldKeyMsg:   &quot;@message&quot;,</span>
	<span class="token comment">// 		 FieldKeyFunc:  &quot;@caller&quot;,</span>
	<span class="token comment">//    },</span>
	<span class="token comment">// }</span>
	FieldMap FieldMap

	<span class="token comment">// CallerPrettyfier can be set by the user to modify the content</span>
	<span class="token comment">// of the function and file keys in the json data when ReportCaller is</span>
	<span class="token comment">// activated. If any of the returned value is the empty string the</span>
	<span class="token comment">// corresponding key will be removed from json fields.</span>
	CallerPrettyfier <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>runtime<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">(</span>function <span class="token builtin">string</span><span class="token punctuation">,</span> file <span class="token builtin">string</span><span class="token punctuation">)</span>

	<span class="token comment">// PrettyPrint will indent all json logs</span>
	PrettyPrint <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="自定义-formatter"><a href="#自定义-formatter" class="header-anchor">#</a> 自定义 Formatter</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>

	log <span class="token string">&quot;github.com/Sirupsen/logrus&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化自定义 formatter</span>
	formatter <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyFormatter<span class="token punctuation">{</span>
		Prefix<span class="token punctuation">:</span> <span class="token string">&quot;prefix&quot;</span><span class="token punctuation">,</span>
		Suffix<span class="token punctuation">:</span> <span class="token string">&quot;suffix&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">SetFormatter</span><span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Infoln</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// MyFormatter 自定义 formatter</span>
<span class="token keyword">type</span> MyFormatter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Prefix <span class="token builtin">string</span>
	Suffix <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// Format implement the Formatter interface</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mf <span class="token operator">*</span>MyFormatter<span class="token punctuation">)</span> <span class="token function">Format</span><span class="token punctuation">(</span>entry <span class="token operator">*</span>log<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> b <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer
	<span class="token keyword">if</span> entry<span class="token punctuation">.</span>Buffer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		b <span class="token operator">=</span> entry<span class="token punctuation">.</span>Buffer
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		b <span class="token operator">=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token comment">// entry.Message 就是需要打印的日志</span>
	b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s - %s - %s&quot;</span><span class="token punctuation">,</span> mf<span class="token punctuation">.</span>Prefix<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> mf<span class="token punctuation">.</span>Suffix<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>打印结果如下:</p> <div class="language-go extra-class"><pre class="language-go"><code>prefix <span class="token operator">-</span> hello world <span class="token operator">-</span> suffix
</code></pre></div><h3 id="总结使用"><a href="#总结使用" class="header-anchor">#</a> 总结使用</h3> <p>为了满足公司日志要求
1.格式
时间 日志等级 msg 文件名行号</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">24</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">28.487</span> info <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> running <span class="token punctuation">[</span>marketDataMysql<span class="token operator">/</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">336</span><span class="token punctuation">]</span>
</code></pre></div><p>2.分割
按大小分割,最大保留天数</p> <p><strong>代码如下:</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> logrus

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;github.com/natefinch/lumberjack&quot;</span>
	log <span class="token string">&quot;github.com/sirupsen/logrus&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>


<span class="token comment">// line number hook for log the call context,</span>
<span class="token keyword">type</span> lineHook <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Field  <span class="token builtin">string</span>
	<span class="token comment">// skip为遍历调用栈开始的索引位置</span>
	Skip   <span class="token builtin">int</span>
	levels <span class="token punctuation">[</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>Level
<span class="token punctuation">}</span>

<span class="token comment">// Levels implement levels</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>hook lineHook<span class="token punctuation">)</span> <span class="token function">Levels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>Level <span class="token punctuation">{</span>
	<span class="token keyword">return</span> log<span class="token punctuation">.</span>AllLevels
<span class="token punctuation">}</span>

<span class="token comment">// Fire implement fire</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>hook lineHook<span class="token punctuation">)</span> <span class="token function">Fire</span><span class="token punctuation">(</span>entry <span class="token operator">*</span>log<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	entry<span class="token punctuation">.</span>Data<span class="token punctuation">[</span>hook<span class="token punctuation">.</span>Field<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">findCaller</span><span class="token punctuation">(</span>hook<span class="token punctuation">.</span>Skip<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">findCaller</span><span class="token punctuation">(</span>skip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	file <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
	line <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token comment">//var pc uintptr</span>
	<span class="token comment">// 遍历调用栈的最大索引为第11层.</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">getCaller</span><span class="token punctuation">(</span>skip <span class="token operator">+</span> i<span class="token punctuation">)</span>
		<span class="token comment">// 过滤掉所有logrus包，即可得到生成代码信息</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;logrus&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getCaller</span><span class="token punctuation">(</span>skip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pc<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> ok <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Caller</span><span class="token punctuation">(</span>skip<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pc
	<span class="token punctuation">}</span>
	n <span class="token operator">:=</span> <span class="token number">0</span>

	<span class="token comment">// 获取包名</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> file<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
			n<span class="token operator">++</span>
			<span class="token keyword">if</span> n <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
				file <span class="token operator">=</span> file<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> pc
<span class="token punctuation">}</span>
<span class="token comment">// MyFormatter 自定义 formatter</span>
<span class="token keyword">type</span> MyFormatter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">getGID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span>
	b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
	b <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token punctuation">:</span>runtime<span class="token punctuation">.</span><span class="token function">Stack</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	b <span class="token operator">=</span> bytes<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;goroutine &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	b <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token punctuation">:</span>bytes<span class="token punctuation">.</span><span class="token function">IndexByte</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	n<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseUint</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> n
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>mf <span class="token operator">*</span>MyFormatter<span class="token punctuation">)</span> <span class="token function">Format</span><span class="token punctuation">(</span>entry <span class="token operator">*</span>log<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> b <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer
	<span class="token keyword">if</span> entry<span class="token punctuation">.</span>Buffer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		b <span class="token operator">=</span> entry<span class="token punctuation">.</span>Buffer
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		b <span class="token operator">=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	timeParse<span class="token operator">:=</span> entry<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;2006-01-02 15:04:05.000&quot;</span><span class="token punctuation">)</span>
	threadId<span class="token operator">:=</span><span class="token function">getGID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> path <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span>ok<span class="token operator">:=</span>entry<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ok<span class="token punctuation">{</span>
		path<span class="token operator">=</span>entry<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s %s [%d] %s [%s]\n&quot;</span><span class="token punctuation">,</span> timeParse<span class="token punctuation">,</span>entry<span class="token punctuation">.</span>Level<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>Message<span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>filePath <span class="token builtin">string</span><span class="token punctuation">,</span>maxsize <span class="token builtin">int</span><span class="token punctuation">,</span>maxBackups <span class="token builtin">int</span><span class="token punctuation">,</span>maxAge <span class="token builtin">int</span><span class="token punctuation">,</span>compress <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	lumberjackLogrotate <span class="token operator">:=</span> <span class="token operator">&amp;</span>lumberjack<span class="token punctuation">.</span>Logger<span class="token punctuation">{</span>
		Filename<span class="token punctuation">:</span>   filePath<span class="token punctuation">,</span>
		MaxSize<span class="token punctuation">:</span>    maxsize<span class="token punctuation">,</span>  <span class="token comment">// Max megabytes before log is rotated</span>
		MaxBackups<span class="token punctuation">:</span> maxBackups<span class="token punctuation">,</span> <span class="token comment">// Max number of old log files to keep</span>
		MaxAge<span class="token punctuation">:</span>     maxAge<span class="token punctuation">,</span> <span class="token comment">// Max number of days to retain log files</span>
		Compress<span class="token punctuation">:</span>   compress<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	formatter <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyFormatter<span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">SetFormatter</span><span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
	logMultiWriter <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">MultiWriter</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> lumberjackLogrotate<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">SetOutput</span><span class="token punctuation">(</span>logMultiWriter<span class="token punctuation">)</span>
	hook<span class="token operator">:=</span>lineHook<span class="token punctuation">{</span>Skip<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span>Field<span class="token punctuation">:</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">AddHook</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hook<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>参考资料</p> <ul><li><a href="https://blog.csdn.net/wslyk606/article/details/81670713" target="_blank" rel="noopener noreferrer">golang日志框架之logrus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/sirupsen/logrus/issues/679" target="_blank" rel="noopener noreferrer">Lumberjack hook for Logrus #679<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.jssyjam.com/articles/2019/11/08/1573194915335.html" target="_blank" rel="noopener noreferrer">logrus 剖析之 formatter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020年5月5日星期二下午5点09分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backend/golang/distributed.html" class="prev">
        分布式技术原理
      </a></span> <span class="next"><a href="/backend/golang/map.html">
        哈希表
      </a>
      →
    </span></p></div>  <!----></main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.ee61cafb.js" defer></script><script src="/assets/js/6.a4c4b5d6.js" defer></script><script src="/assets/js/2.1492d491.js" defer></script><script src="/assets/js/14.2ec4739f.js" defer></script><script src="/assets/js/3.90399333.js" defer></script>
  </body>
</html>
